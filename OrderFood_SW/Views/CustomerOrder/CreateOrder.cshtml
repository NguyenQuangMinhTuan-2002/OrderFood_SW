@model OrderFood_SW.ViewModels.OrderPageModel
@{
    Layout = "_CustomerLayout";
}

<div class="container" style="padding-top: 5px;">
    <div class="hero">
        <h1>Satisfy Your Cravings</h1>
    </div>

    <div class="search-bar">
        <input type="text" class="search-input" placeholder="Search for your favorite dish..." id="searchInput">
    </div>

    <div class="categories">
        <button class="category-btn active" data-category-id="0">All</button>
        @foreach (var item in Model.DishCategories)
        {
            <button class="category-btn" data-category-id="@item.CategoryId">@item.CategoryName</button>
        }
    </div>

    <div class="menu-grid">
        @foreach (var item in Model.FoundDishes)
        {
            var inCart = Model.CartItems.Any(c => c.DishId == item.DishId);
            <div class="menu-item" data-category="@item.CategoryId">
                <div class="item-image"><img src="~/images/Products/@item.ImageUrl"></div>
                <div class="item-content">
                    <h3 class="item-name">@item.DishName</h3>
                    <p class="item-description">@item.DishDescription</p>
                    <div class="item-footer">
                        <span class="item-price">@item.DishPrice</span>
                        <button class="add-to-cart @(inCart ? "added" : "")"
                            onclick="addToCart(this, @item.DishId, 1)"
                            @(inCart ? "disabled" : "")>
                            @(inCart ? "Added" : "Add to Cart")
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<script>
    // Simple search functionality
    document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const menuItems = document.querySelectorAll('.menu-item');

        menuItems.forEach(item => {
                const itemName = item.querySelector('.item-name').textContent.toLowerCase();
                const itemDescription = item.querySelector('.item-description').textContent.toLowerCase();

                if (itemName.includes(searchTerm) || itemDescription.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });

    // Category button active state management
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Xóa active khỏi tất cả nút
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            // Thêm active vào nút được bấm
            this.classList.add('active');

            // Lấy categoryId của nút được chọn
            const selectedCategoryId = parseInt(this.getAttribute('data-category-id'));

            // Lọc menu-item
            document.querySelectorAll('.menu-item').forEach(item => {
                const itemCategoryId = parseInt(item.getAttribute('data-category'));
                if (selectedCategoryId === 0 || itemCategoryId === selectedCategoryId) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });

            // Reset ô tìm kiếm
            document.getElementById('searchInput').value = '';
        });
    });

    function addToCart(button, dishId, quantity) {
        const formData = new URLSearchParams();
        formData.append('dishId', dishId);
        formData.append('Quantity', quantity);

        fetch('/CustomerOrder/AddCart', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formData.toString()
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Cập nhật badge
                const cartBadge = document.getElementById('cartBadge');
                if (cartBadge) {
                    cartBadge.textContent = data.cartCount;
                    cartBadge.style.display = data.cartCount > 0 ? 'inline-block' : 'none';
                }

                // Đổi nút sang "Added"
                button.textContent = 'Added';
                button.classList.add('added');
                button.disabled = true;

                // Hiển thị thông báo
                showToast(`✅ ${data.message}`);
            } else {
                showToast(`❌ ${data.message}`);
            }
        })
        .catch(() => {
            showToast('❌ Unable to add to cart!');
        });
    }

    function showToast(message) {
        let toast = document.getElementById("toast-message");
        if (!toast) {
            toast = document.createElement("div");
            toast.id = "toast-message";
            // inline style tối thiểu, không đụng CSS của bạn
            toast.style.position = "fixed";
            toast.style.right = "20px";
            toast.style.bottom = "20px";
            toast.style.background = "rgba(0,0,0,.8)";
            toast.style.color = "#fff";
            toast.style.padding = "10px 14px";
            toast.style.borderRadius = "8px";
            toast.style.fontSize = "14px";
            toast.style.zIndex = "9999";
            toast.style.display = "none";
            document.body.appendChild(toast);
        }
        toast.textContent = message;
        toast.style.display = "block";
        clearTimeout(toast._h);
        toast._h = setTimeout(() => { toast.style.display = "none"; }, 2500);
    }
</script>